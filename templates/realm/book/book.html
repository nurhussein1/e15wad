{% extends 'realm/base.html' %}
{% load staticfiles %}

{% block title_block %}Category{% endblock %}

{% block body_block %}
{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li {% if message.tags %}class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<head>
    <title>{{ book.title }}</title>
    <style>
        a {
            color: blue;
        }
        .star-rating .star {
            cursor: pointer;
            font-size: 24px;
            color: lightgray;
        }
        .star-rating .filled {
            color: gold;
        }
    </style>
</head>

<body>
    <header>
        <h1>{{ book.title }}</h1>
    </header>
    <main>
        <div>
            <img src="{{book.bookcover}}" height=75 width=35 style="height: 945px;width: 100%;" >
            <blockquote>
                {% if book.description %}
                {{ book.description }}
                {% else %}
                No Description
                {% endif %}
            </blockquote>
        </div>
        <div>
            <blockquote>
                {% if book.estimatedreadingtime %}
                {{ book.estimatedreadingtime }}
                {% else %}
                No Estimated Reading Time Specified
                {% endif %}
            </blockquote>
        </div>

        {% if user.is_authenticated %}
        <div style="text-align: center; padding: 20px;">
            <a href="{% url 'realm:purchase_book' book.id %}" class="buy-link">Purchase</a><span class="price">${{ book.purchase_price }}</span>
            <a href="{% url 'realm:rent_book' book.id %}" class="rent-link">Rent</a><span class="price">${{ book.rent_price }}</span>
            <a href="{% url 'realm:add_to_wishlist' book.id %}" class="wishlist-link">Add to Wishlist</a>
        </div>
        {% else %}
        <div style="text-align: center;"><p>You must be logged in to make a purchase or rent a book.</p></div>
        {% endif %}
    </main>
    <footer>
        <p>Find Out More <a href="{{ book.url }}">Here</a></p>
        <p>About the <a href="{{ book.author }}">Author</a></p>
        <p>Return back to <a href="{% url 'realm:Categories' %}">Categories</a></p><br />
        {% if user_has_purchased or user_has_active_rental %}
        <p>Read the book <a href="{% url 'realm:read_book' book.slug %}">Read Book</a></p><br />
        {% else %}
        <p>You must purchase/rent the book to read it.</p>
        {% endif %}
    </footer>

    <div>
        <h2>Reviews</h2>
        {% for review in reviews %}
        
        <div>
            {% if review.user.userprofile.profilepicture %}
            <img src="{{ review.user.userprofile.profilepicture.url }}" alt="Profile picture" style="width: 50px; height: 50px; border-radius: 50%;">
            {% endif %}
            
            <strong>{{ review.user.username }}</strong> ({{ review.created_at }}):
            <p>{{ review.comment }}</p>
            <div class="rating">
                {% for i in star_range %}
                    {% if forloop.counter <= review.rating %}
                        ★
                    {% else %}
                        ☆
                    {% endif %}
                {% endfor %}
            </div>
            {% if request.user == review.user %}
            <form action="{% url 'realm:delete_review' review.id %}" method="post" style="display: inline;">
                {% csrf_token %}
                <input type="submit" value="Delete" onclick="return confirm('Are you sure?');">
            </form>
            {% endif %}
        </div>
        {% empty %}
        <p>No reviews yet.</p>
        {% endfor %}
    </div>

    {% if user.is_authenticated %}
    {% if user_has_purchased or user_has_active_rental %}
    <h2>Add a review</h2>
    <form method="post" id="reviewForm">
        {% csrf_token %}
        
        <!-- Render the comment field -->
        {{ review_form.comment }}
        
        <!-- Star rating -->
        <div class="star-rating">
            {% for value in star_range %}
            <input type="radio" name="rating" value="{{ value }}" id="rating-{{ value }}" {% if forloop.first %}checked{% endif %} class="rating-radio" hidden>
            <label for="rating-{{ value }}" class="star">&#9733;</label>
            {% endfor %}
        </div>
        
        <!-- Submit button -->
        <div style="margin-top: 20px; text-align: center;">
            <a style="background-color: rgb(45, 149, 150); color: white; padding: 10px 15px; border: none; border-radius: 20px; text-decoration: none; cursor: pointer;" onclick="document.getElementById('reviewForm').submit();">Submit Review</a>
        </div>
    </form>
    {% else %}
    <p>You must purchase or rent the book to be able to add a review.</p>
    {% endif %}
{% else %}
<p><a href="{% url 'realm:login' %}">Log in</a> to add a review.</p>
{% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.star-rating .star').forEach(function(star, index) {
            star.addEventListener('click', function() {
                let allStars = document.querySelectorAll('.star-rating .star');
                allStars.forEach((star, idx) => {
                    if (idx <= index) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
                let radioButtons = document.querySelectorAll('.rating-radio');
                radioButtons[index].checked = true;
            });
        });
    });
</script>
</body>
{% endblock %}

       
